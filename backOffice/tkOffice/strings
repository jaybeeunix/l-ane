#!/usr/bin/perl -w

#tkOffice/strings
#Copyright 2001-2005 Jason Burrell

#This is the strings back office program for L'anePOS
#$Id: strings 1193 2010-10-22 21:10:11Z jason $

BEGIN {
    use FindBin;
    use File::Spec;
    $ENV{'LaneRoot'} = File::Spec->catdir($FindBin::Bin, File::Spec->updir, File::Spec->updir); #use the correct number of updirs
    require File::Spec->catfile($ENV{'LaneRoot'}, 'config', 'init.pl');
}

#lane stuff
use LanePOS::String;
$str = new String;
use LanePOS::Locale;
$lc = new Locale;

$isSaved = 1;

# Sample SpecTcl main program for testing GUI
use Tk;
my($top) = MainWindow->new();
$top->title("L'ane: " . $lc->get('Lane/BackOffice/Strings'));

#$top->bind(Tk::Entry, '<KeyRelease>', sub { # turns off $isSaved if the user types something
#    #it wouldn't do anything when i bound to <Key> or <KeyPress>. don't know why
#    $isSaved = 0;
#});

#############################################################
# general use subs
#############################################################
sub askToSave {			# rtns f-0 if 'Discard/No', t-1 if 'Saved/Yes'
    #prompt w/a popup window:
    # "This record is not saved. Do you want a chance to save your changes?"
    # Yes (chance to save) -  No (discard)

    #askToSave doesn't work how it should
    #so, i've disabled it
    return 0;

    require Tk::DialogBox;
    my $yes = $lc->get('Lane/BackOffice/Buttons/Yes');
    my $popupWin = $top->DialogBox(
		       -title => $lc->get('Lane/BackOffice/Confirmation'),
		       -buttons => [$yes, $lc->get('Lane/BackOffice/Buttons/No, Discard')]
		  );
    $popupWin->add(Label, -text => $lc->get('Lane/BackOffice/Save Prompt'))->pack();
#    $popupWin->add(Label, -text => "(Selecting 'Yes' only cancels the previous operation.)")->pack();

    if($popupWin->Show eq $yes)
    {
	$popupWin->destroy;
	return 1;
    }
    $popupWin->destroy;
    return 0;			# didn't want to save
}

sub newRec {
    unless($isSaved)
    {
	if(&askToSave)		# ask user if he/she wants to save
	{
	    #the user wants to save the file first
	    return;
	}
    }
    #either user didn't want to save, or it was already saved

    #clear the flds
    $str->{'id'} = $str->{'data'} = '';
    $txtData->delete('1.0', 'end');

    $isSaved = 1;
    #move to the default fld
    $entId->focus;
}

sub validateStr {
    my ($len, $new, $chars, $curr, $ndx, $type) = @_;

    return 1 if length($new) <= $len;
    return 0;
}

# interface generated by SpecTcl (Perl enabled) version 1.1 
# from /burrell/LanePOS/backOffice/tkOffice/ui.files/strings.ui
# For use with Tk402.002, using the grid geometry manager

sub strings_ui {
	my($root) = @_;

	# widget creation 

	my($frame_1) = $root->Frame (
	);
	my($label_1) = $root->Label (
		-text => $lc->get('Lane/GenericObject/ID'),
	);
	$entId = $root->Entry (
			       -textvariable => \$str->{'id'},
			       -width => '50',
			       -validate => 'key',
			       -vcmd => sub {&validateStr(100,@_);},
			       -invcmd => sub { $root->bell(); },
			       );
	my($label_2) = $root->Label (
		-text => $lc->get('Lane/String/Data'),
	);
	$txtData = $root->Scrolled('Text', 
				   -scrollbars => 'oe',
				   -height => '15',
				   -width => '90',
				   -wrap => 'word',
				   -font => '-*-Helvetica-Medium-R-Normal-*-*-120-*-*-*-*-*-*',
	);
	my($bProcess) = $root->Button (
		-text => $lc->get('Lane/BackOffice/Buttons/Process'),
	);
	my($bQuit) = $root->Button (
		-text => $lc->get('Lane/BackOffice/Buttons/Quit'),
	);

	# widget commands

	$bProcess->configure(
		-command => sub {
		    #cp the data from the text into $str->{'data'}
#		    $str->{'data'} = sprintf "%.2048s", $txtData->get('1.0', 'end');
		    $str->{'data'} = $txtData->get('1.0', 'end');
		    chop $str->{'data'};
		    return if($str->{'id'} eq '' or $str->{'data'} eq '');
		    $str->save;
		    $isSaved = 1;
		    &newRec;
		}
	);
	$bQuit->configure(
		-command => sub {
		    if($isSaved)
		    {
			exit;
		    }
		    if(&askToSave)
		    {
			return; # user wants a chance to save
		    }
		    exit; #discard selected
		}
	);

	# Geometry management

	$frame_1->grid(
		-in => $root,
		-column => '1',
		-row => '3',
		-columnspan => '2',
		-sticky => 'e'
	);
	$label_1->grid(
		-in => $root,
		-column => '1',
		-row => '1',
		-sticky => 'e'
	);
	$entId->grid(
		-in => $root,
		-column => '2',
		-row => '1',
		-sticky => 'w'
	);
	$label_2->grid(
		-in => $root,
		-column => '1',
		-row => '2',
		-sticky => 'e'
	);
	$txtData->grid(
		-in => $root,
		-column => '2',
		-row => '2',
		-sticky => 'nesw'
	);
	$bProcess->grid(
		-in => $frame_1,
		-column => '1',
		-row => '1'
	);
	$bQuit->grid(
		-in => $frame_1,
		-column => '2',
		-row => '1'
	);

	# Resize behavior management

	# container $root (rows)
	$root->gridRowconfigure(1, -weight  => 0, -minsize  => 30);
	$root->gridRowconfigure(2, -weight  => 0, -minsize  => 30);
	$root->gridRowconfigure(3, -weight  => 0, -minsize  => 30);

	# container $root (columns)
	$root->gridColumnconfigure(1, -weight => 0, -minsize => 30);
	$root->gridColumnconfigure(2, -weight => 0, -minsize => 30);

	# container $frame_1 (rows)
	$frame_1->gridRowconfigure(1, -weight  => 0, -minsize  => 30);

	# container $frame_1 (columns)
	$frame_1->gridColumnconfigure(1, -weight => 0, -minsize => 30);
	$frame_1->gridColumnconfigure(2, -weight => 0, -minsize => 30);

	# additional interface code
	$entId->bind('<Return>', sub{
	    &askToSave unless $isSaved;
	    unless($str->open($str->{'id'}))
	    {
		$isSaved = 1; #to trick newRec()
		&newRec;
		$entId->focus();
	    }
	    else
	    {
		#display the info in the text
		$txtData->delete('1.0', 'end'); # clear it first
		$txtData->insert('end', $str->{'data'});
		$isSaved = 1;
		shift->focusNext()->focus();
	    }
	});

	# end additional interface code
}


strings_ui $top;
#this is to trick newRec() into not asking "save?"
$isSaved = 1;
&newRec;
Tk::MainLoop;

1;

#!/usr/bin/perl -w

#tkOffice/taxes
#Copyright 2001-2005 Jason Burrell

#This is the taxes back office program for L'anePOS
#$Id: taxes 1193 2010-10-22 21:10:11Z jason $

BEGIN {
    use FindBin;
    use File::Spec;
    $ENV{'LaneRoot'} = File::Spec->catdir($FindBin::Bin, File::Spec->updir, File::Spec->updir); #use the correct number of updirs
    require File::Spec->catfile($ENV{'LaneRoot'}, 'config', 'init.pl');
}

#lane stuff
use LanePOS::Tax;
$tax = new Tax;
use LanePOS::Locale;
$lc = new Locale;

$isSaved = 1;

# Sample SpecTcl main program for testing GUI
use Tk;
my($top) = MainWindow->new();
$top->title("L'ane: " . $lc->get('Lane/BackOffice/Taxes'));

$top->bind(Tk::Entry, '<KeyRelease>', sub { # turns off $isSaved if the user types something
    #it wouldn't do anything when i bound to <Key> or <KeyPress>. don't know why
    $isSaved = 0;
});

#############################################################
# general use subs
#############################################################
sub askToSave {			# rtns f-0 if 'Discard/No', t-1 if 'Saved/Yes'
    #prompt w/a popup window:
    # "This record is not saved. Do you want a chance to save your changes?"
    # Yes (chance to save) -  No (discard)

    #askToSave doesn't work how it should
    #so, i've disabled it
    return 0;

}

sub newRec {
    unless($isSaved)
    {
	if(&askToSave)		# ask user if he/she wants to save
	{
	    #the user wants to save the file first
	    return;
	}
    }
    #either user didn't want to save, or it was already saved

    #clear the flds
    $tax->{'id'} = $tax->{'descr'} = $tax->{'amount'} = '';

    $isSaved = 1;
    #move to the default fld
    $entId->focus;
}

sub validateDec {
    my ($whole, $fract, $new, $chars, $curr, $ndx, $type) = @_;
    #$whole is the # digits in the whole part, $fract is the # of digits in the fractional part

    #make sure it is even a number
    return 0 if $new =~ /[^\d\.\-]/; #remove non-number chars
    #bounds checking
    return 0 if $new > 10 ** $whole - 1;
    return 0 if $new < - (10 ** $whole - 1);
    $new =~ /\./;
    return 0 if length($') > $fract; #' damn emacs
    return 0 if $new =~ s/\./\./g > 1;
    return 0 if $new =~ s/\-/\-/g > 1;
    if($new =~ /\-/) #it has a dash in it
    {
	return 0 unless $new =~ /^\-/;
    }
    return 1;
}

sub validateInt {
    my ($new, $chars, $curr, $ndx, $type) = @_;

    #allow the fld to be blank
    return 1 if length($new) == 0;
    return 1 if int($new) eq $new; #i want this string comparison
    return 0;
}

sub validateStr {
    my ($len, $new, $chars, $curr, $ndx, $type) = @_;

    return 1 if length($new) <= $len;
    return 0;
}

# interface generated by SpecTcl (Perl enabled) version 1.1 
# from /burrell/LanePOS/backOffice/tkOffice/ui.files/taxes.ui
# For use with Tk402.002, using the grid geometry manager

sub taxes_ui {
	my($root) = @_;

	# widget creation 

	my($frame_1) = $root->Frame (
	);
	my($label_1) = $root->Label (
		-text => $lc->get('Lane/GenericObject/ID'),
	);
	$entId = $root->Entry (
			       -justify => 'right',
			       -textvariable => \$tax->{'id'},
			       -width => '4',
			       -validate => 'key',
			       -vcmd => \&validateInt,
			       -invcmd => sub { $root->bell(); },
			       );
	my($label_2) = $root->Label (
				     -text => $lc->get('Lane/Tax/Description'),
				     );
	my($entDescr) = $root->Entry (
				      -textvariable => \$tax->{'descr'},
				      -validate => 'key',
				      -vcmd => sub {&validateStr(20,@_);},
				      -invcmd => sub { $root->bell(); },
				      );
	my($label_3) = $root->Label (
		-text => $lc->get('Lane/Tax/Amount'),
	);
	my($entAmount) = $root->Entry (
				       -justify => 'right',
				       -textvariable => \$tax->{'amount'},
				       -validate => 'key',
				       -vcmd => sub {&validateDec(8,4,@_);},
				       -invcmd => sub { $root->bell(); },
				       );
	my($label_4) = $root->Label (
		-text => '%',
	);
	my($bProcess) = $root->Button (
		-text => $lc->get('Lane/BackOffice/Buttons/Process'),
	);
	my($bNew) = $root->Button (
		-text => $lc->get('Lane/BackOffice/Buttons/New'),
	);
	my($bRemove) = $root->Button (
		-text => $lc->get('Lane/BackOffice/Buttons/Remove'),
	);
	my($bQuit) = $root->Button (
		-text => $lc->get('Lane/BackOffice/Buttons/Quit'),
	);

	# widget commands
	$bProcess->configure(
		-command => sub {
		    return if($tax->{'id'} eq '' or $tax->{'descr'} eq '' or $tax->{'amount'} eq '');
		    $tax->save;
		    $isSaved = 1;
		    &newRec;
		}
	);
	$bNew->configure(
		-command => sub {&newRec;}
	);
	$bRemove->configure(
		-command => sub {
		    require Tk::DialogBox;
		    my $yes = $lc->get('Lane/BackOffice/Buttons/Yes, Remove');
		    my $popupWin = $top->DialogBox(
						   -title => $lc->get('Lane/BackOffice/Confirmation'),
						   -buttons => [$lc->get('Lane/BackOffice/Buttons/No, Cancel'), $yes]
						   );
		    $popupWin->add(Label, -text => $lc->get('Lane/BackOffice/Remove Prompt'))->pack();
#		    $popupWin->add(Label, -text => "remove this record from the database?")->pack();
		    $popupWin->add(Label, -text => "[$tax->{'id'}, $tax->{'descr'}]")->pack();
		    
		    if($popupWin->Show eq $yes)
		    {
			$popupWin->destroy;
			$tax->remove;
			$isSaved = 1; # to trick newRec
			&newRec;
		    }
		    else
		    {
			$popupWin->destroy;
		    }
		    
		}
	);

	$bQuit->configure(
		-command => sub {
		    if($isSaved)
		    {
			exit;
		    }
		    if(&askToSave)
		    {
			return; # user wants a chance to save
		    }
		    exit; #discard selected
		}
	);

	# Geometry management

	$frame_1->grid(
		-in => $root,
		-column => '1',
		-row => '4',
		-columnspan => '3',
		-sticky => 'e'
	);
	$label_1->grid(
		-in => $root,
		-column => '1',
		-row => '1',
		-sticky => 'e'
	);
	$entId->grid(
		-in => $root,
		-column => '2',
		-row => '1',
		-sticky => 'w'
	);
	$label_2->grid(
		-in => $root,
		-column => '1',
		-row => '2',
		-sticky => 'e'
	);
	$entDescr->grid(
		-in => $root,
		-column => '2',
		-row => '2',
		-sticky => 'w'
	);
	$label_3->grid(
		-in => $root,
		-column => '1',
		-row => '3',
		-sticky => 'e'
	);
	$entAmount->grid(
		-in => $root,
		-column => '2',
		-row => '3',
		-sticky => 'w'
	);
	$label_4->grid(
		-in => $root,
		-column => '3',
		-row => '3',
		-sticky => 'w'
	);
	$bProcess->grid(
		-in => $frame_1,
		-column => '1',
		-row => '1'
	);
	$bNew->grid(
		-in => $frame_1,
		-column => '2',
		-row => '1'
	);
	$bRemove->grid(
		-in => $frame_1,
		-column => '3',
		-row => '1'
	);
	$bQuit->grid(
		-in => $frame_1,
		-column => '4',
		-row => '1'
	);

	# Resize behavior management

	# container $root (rows)
	$root->gridRowconfigure(1, -weight  => 0, -minsize  => 30);
	$root->gridRowconfigure(2, -weight  => 0, -minsize  => 30);
	$root->gridRowconfigure(3, -weight  => 0, -minsize  => 30);
	$root->gridRowconfigure(4, -weight  => 0, -minsize  => 30);

	# container $root (columns)
	$root->gridColumnconfigure(1, -weight => 0, -minsize => 30);
	$root->gridColumnconfigure(2, -weight => 0, -minsize => 30);
	$root->gridColumnconfigure(3, -weight => 0, -minsize => 30);

	# container $frame_1 (rows)
	$frame_1->gridRowconfigure(1, -weight  => 0, -minsize  => 30);

	# container $frame_1 (columns)
	$frame_1->gridColumnconfigure(1, -weight => 0, -minsize => 30);
	$frame_1->gridColumnconfigure(2, -weight => 0, -minsize => 30);
	$frame_1->gridColumnconfigure(3, -weight => 0, -minsize => 30);
	$frame_1->gridColumnconfigure(4, -weight => 0, -minsize => 30);

	# additional interface code
	$entId->bind('<Return>', sub{
	    &askToSave unless $isSaved;
	    unless($tax->open($tax->{'id'}))
	    {
		$isSaved = 1; #to trick newRec()
		&newRec;
		$entId->focus();
	    }
	    else
	    {
		$isSaved = 1;
		shift->focusNext()->focus();
	    }
	});

	# end additional interface code
}


taxes_ui $top;
#this is to trick newRec() into not asking "save?"
$isSaved = 1;
&newRec;
Tk::MainLoop;

1;
